#!/usr/bin/env bash
set -e

VERSION=1.10.0
PACKAGE=nginx-$VERSION.tar.gz
BASEDIR=upstream
SRCDIR=nginx-$VERSION

# Remove build dir
rm -rf upstream
# Recreate build dir
mkdir upstream
# Only download the tarball if we don't have it already. If we have it
# just copy it into the build dir
echo "Getting Nginx version" $VERSION
if [ ! -f $PACKAGE ]; then
    wget nginx.org/download/$PACKAGE
fi

cp $PACKAGE upstream
cd upstream

# Untar
tar xzvf $PACKAGE
cd $SRCDIR

# Patch the linker conf (auto/cc/conf) so that "-shared" gets added to the
# LINK step for nginx.
# Passing -shared in via cc-opt or CFLAGS does not achieve it. The
# link step generated by ./configure does not refer to CFLAGS variables so
# we patch the MAIN_LINK variable used by .configure instead
patch auto/cc/conf < ../../shared_link.patch
patch src/os/unix/ngx_process.c < ../../ngx_process.patch

./configure --without-http_rewrite_module --with-cc-opt='-O2 -D_FORTIFY_SOURCE=2 -fPIC' --with-ld-opt="-pie"

make
cp objs/nginx ../nginx-osv.so
cp conf/mime.types ../mime.types
# Necessary to copy into top-level dir?
cp conf/mime.types ../../mime.types
cp objs/nginx ../../nginx-osv.so

# Go up into parent dir (upstream)
cd ..
cp ../nginx.conf .

# Generate usr.manifest
cat > usr.manifest <<EOF
[manifest]
# This file is automatically generated
/nginx-osv.so: \${MODULE_DIR}/upstream/nginx-osv.so
/usr/local/nginx/conf/nginx.conf: \${MODULE_DIR}/nginx.conf
/usr/local/nginx/conf/mime.types: \${MODULE_DIR}/upstream/mime.types
/usr/local/nginx/logs: \${MODULE_DIR}/logs
/usr/local/nginx/html/index.html: \${MODULE_DIR}/index.html
EOF

cp usr.manifest ..
